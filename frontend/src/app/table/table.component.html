<div class="container">
  <form [formGroup]="filterForm" *ngIf="preference | async as prefs">
    <mat-form-field appearance="fill">
      <mat-label>Ville</mat-label>
      <mat-select formControlName="ville">
        <mat-option [value]="ville" *ngFor="let ville of prefs.ville">{{
          ville
        }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Relation</mat-label>
      <mat-select formControlName="relation">
        <mat-option value="AND">And</mat-option>
        <mat-option value="OR">Or</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="fill">
      <mat-label>Etat d'avancement</mat-label>
      <mat-select formControlName="etat_d_avancement">
        <mat-option
          [value]="etat_d_avancement"
          *ngFor="let etat_d_avancement of prefs.etat_d_avancement"
          >{{ etat_d_avancement }}</mat-option
        >
      </mat-select>
    </mat-form-field>
  </form>
  <div
    class=" mat-elevation-z8"
    *ngIf="investmentResponse | async; else loading"
  >
    <table
      mat-table
      [dataSource]="filteredAndPagedInvestments"
      class="table"
      matSort
      matSortDisableClear
      matSortDirection="desc"
    >
      <ng-container matColumnDef="codeuai" sticky>
        <th mat-header-cell *matHeaderCellDef>CodeUAI</th>
        <td mat-cell *matCellDef="let row">{{ row.codeuai }}</td>
      </ng-container>

      <ng-container matColumnDef="lycee">
        <th mat-header-cell *matHeaderCellDef>Lycée</th>
        <td mat-cell *matCellDef="let row">{{ row.lycee }}</td>
      </ng-container>

      <ng-container matColumnDef="ville">
        <th mat-header-cell *matHeaderCellDef>Ville</th>
        <td mat-cell *matCellDef="let row">{{ row.ville }}</td>
      </ng-container>

      <ng-container matColumnDef="ppi">
        <th mat-header-cell *matHeaderCellDef>
          ppi
        </th>
        <td mat-cell *matCellDef="let row">{{ row.ppi }}</td>
      </ng-container>

      <ng-container matColumnDef="annee_d_individualisation">
        <th mat-header-cell *matHeaderCellDef>
          Année d’individualisation
        </th>
        <td mat-cell *matCellDef="let row">
          {{ row.annee_d_individualisation }}
        </td>
      </ng-container>

      <ng-container matColumnDef="titreoperation">
        <th mat-header-cell *matHeaderCellDef>
          Titre Operation
        </th>
        <td mat-cell *matCellDef="let row">{{ row.titreoperation }}</td>
      </ng-container>

      <ng-container matColumnDef="enveloppe_prev_en_meu">
        <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear>
          Enveloppe prév (M€)
        </th>
        <td mat-cell *matCellDef="let row">
          {{ row.enveloppe_prev_en_meu | number }}
        </td>
      </ng-container>

      <ng-container matColumnDef="montant_des_ap_votes_en_meu">
        <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear>
          Montant des AP votés (M€)
        </th>
        <td mat-cell *matCellDef="let row">
          {{ row.montant_des_ap_votes_en_meu | number }}
        </td>
      </ng-container>

      <ng-container matColumnDef="mandataire">
        <th mat-header-cell *matHeaderCellDef>
          Mandataire
        </th>
        <td mat-cell *matCellDef="let row">{{ row.mandataire }}</td>
      </ng-container>

      <ng-container matColumnDef="maitrise_d_oeuvre">
        <th mat-header-cell *matHeaderCellDef>
          Maîtrise d’œuvre
        </th>
        <td mat-cell *matCellDef="let row">{{ row.maitrise_d_oeuvre }}</td>
      </ng-container>

      <ng-container matColumnDef="notification_du_marche">
        <th mat-header-cell *matHeaderCellDef>
          Notification du marché
        </th>
        <td mat-cell *matCellDef="let row">{{ row.notification_du_marche }}</td>
      </ng-container>

      <ng-container matColumnDef="entreprise">
        <th mat-header-cell *matHeaderCellDef>
          Entreprise
        </th>
        <td mat-cell *matCellDef="let row">{{ row.entreprise }}</td>
      </ng-container>

      <ng-container matColumnDef="mode_de_devolution">
        <th mat-header-cell *matHeaderCellDef>
          Mode de dévolution
        </th>
        <td mat-cell *matCellDef="let row">{{ row.mode_de_devolution }}</td>
      </ng-container>

      <ng-container matColumnDef="nombre_de_lots">
        <th mat-header-cell *matHeaderCellDef>
          Nombre de lots
        </th>
        <td mat-cell *matCellDef="let row">{{ row.nombre_de_lots }}</td>
      </ng-container>

      <ng-container matColumnDef="cao_attribution">
        <th mat-header-cell *matHeaderCellDef>
          CAO attribution
        </th>
        <td mat-cell *matCellDef="let row">{{ row.cao_attribution }}</td>
      </ng-container>

      <ng-container matColumnDef="etat_d_avancement">
        <th mat-header-cell *matHeaderCellDef>
          Etat d’avancement
        </th>
        <td mat-cell *matCellDef="let row">{{ row.etat_d_avancement }}</td>
      </ng-container>

      <ng-container matColumnDef="annee_de_livraison">
        <th mat-header-cell *matHeaderCellDef>
          Année de Livraison
        </th>
        <td mat-cell *matCellDef="let row">{{ row.annee_de_livraison }}</td>
      </ng-container>

      <ng-container matColumnDef="map" stickyEnd>
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element">
          <button mat-button (click)="modify(element)">
            <mat-icon>create</mat-icon>
          </button>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [length]="resultsLength | async"
      [pageSize]="pageSize | async"
      (page)="getInvestment()"
    ></mat-paginator>
  </div>
</div>

<ng-template #loading>
  <mat-spinner></mat-spinner>
</ng-template>
